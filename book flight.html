<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Book Flight</title>
  <style>
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    nav{background:#333;height:50px;display:flex;align-items:center}
    .nav_button{color:#fff;text-decoration:none;background:#333;border:0;display:flex;align-items:center;justify-content:center;height:100%;padding:0 16px}
    .nav_button:hover{background:#525252}
    .wrap{max-width:960px;margin:20px auto;padding:0 16px}
    .card{border:1px solid #e5e5e5;border-radius:10px;padding:16px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .input,select,button{width:100%;padding:10px;border:1px solid #e5e5e5;border-radius:8px;background:#fff}
    .btn{cursor:pointer}.btn.primary{background:#000;color:#fff}
    .muted{color:#666;font-size:14px}
    .badge{display:inline-block;border:1px solid #e5e5e5;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:8px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
    .note{border:1px solid #e5e5e5;border-radius:8px;padding:8px;margin:10px 0;background:#fafafa}
    .kbd{font-family:ui-monospace,Menlo,monospace;background:#f2f2f2;border:1px solid #e5e5e5;padding:2px 6px;border-radius:6px}
    .grid{display:grid;grid-template-columns:repeat(7,36px);gap:6px;align-items:center}
    .seat{width:36px;height:36px;border:1px solid #ddd;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:#fff}
    .seat.taken{background:#eee;color:#999;cursor:not-allowed}
    .seat.selected{outline:3px solid #000}
    .label{font-size:12px;color:#666}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <nav>
    <a href="main.html" class="nav_button">Home</a>
    <a href="book flight.html" class="nav_button">Flights</a>
    <a href="manage.html" class="nav_button">Manage</a>
    <a href="inflight.html" class="nav_button">In-flight</a>
  </nav>

  <div class="wrap">
    <div id="confirm"></div>

    <div class="card">
      <h2 style="margin:0 0 8px 0">Search Flights <span id="count" class="badge">0 shown</span></h2>
      <p class="muted" style="margin:0 0 10px 0">Pick route and date. If no exact match, similar flights show automatically.</p>
      <form id="searchForm" class="row">
        <div style="grid-column:span 4">
          <label>Origin
            <select name="origin" class="input" required>
              <option value="">Any</option>
            </select>
          </label>
        </div>
        <div style="grid-column:span 4">
          <label>Destination
            <select name="destination" class="input" required>
              <option value="">Any</option>
            </select>
          </label>
        </div>
        <div style="grid-column:span 3">
          <label>Date
            <select name="date" class="input">
              <option value="">Any</option>
            </select>
          </label>
        </div>
        <div style="grid-column:span 1;display:flex;align-items:end;gap:6px">
          <button class="btn primary" type="submit">Go</button>
        </div>
      </form>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="showAll" class="btn" style="width:auto">Show all</button>
        <button id="quickToday" class="btn" style="width:auto">Today only</button>
      </div>
      <div id="fallbackNote" class="note" style="display:none"></div>
      <div id="results"></div>
    </div>

    <div id="step2" class="card" style="margin-top:12px;display:none">
      <h3 style="margin:0 0 8px 0">Select a Seat</h3>
      <div id="chosenFlight" class="muted"></div>
      <div id="seatWrap" style="margin:10px 0"></div>
      <div class="muted">Selected seat: <span class="kbd" id="seatVal">-</span></div>
      <div style="height:1px;background:#eee;margin:14px 0"></div>
      <h3 style="margin:0 0 8px 0">Passenger</h3>
      <form id="bookForm" class="row">
        <div style="grid-column:span 4"><input class="input" name="firstName" placeholder="First name" required></div>
        <div style="grid-column:span 4"><input class="input" name="lastName" placeholder="Last name" required></div>
        <div style="grid-column:span 4"><input class="input" type="email" name="email" placeholder="you@example.com" required></div>
        <div style="grid-column:span 12;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" type="reset">Reset</button>
          <button class="btn primary" type="submit">Confirm Booking</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const STORAGE='fda.bookings.v1';
    const getBookings=()=>JSON.parse(localStorage.getItem(STORAGE)||'[]');
    const saveBookings=(x)=>localStorage.setItem(STORAGE,JSON.stringify(x));

    let flights=[], selectedFlight=null, selectedSeat=null;

    fetch('available_flights.json').then(r=>r.json()).then(data=>{
      flights=data;
      hydrateFilters(data);
      renderResults(sorted(data).slice(0,10), 'Showing top results');
    });

    function hydrateFilters(list){
      const origins=[...new Set(list.map(f=>f.origin))].sort();
      const dests=[...new Set(list.map(f=>f.destination))].sort();
      const dates=[...new Set(list.map(f=>f.departure_date))].sort();
      fill(document.querySelector('select[name="origin"]'), origins);
      fill(document.querySelector('select[name="destination"]'), dests);
      fill(document.querySelector('select[name="date"]'), dates);
    }
    function fill(sel, arr){ for(const v of arr){ const o=document.createElement('option'); o.value=v;o.textContent=v; sel.appendChild(o); } }

    document.getElementById('showAll').onclick=()=>{
      document.getElementById('fallbackNote').style.display='none';
      document.getElementById('searchForm').reset();
      renderResults(sorted(flights), 'Showing all flights');
    };

    document.getElementById('quickToday').onclick=()=>{
      const today = new Date().toISOString().slice(0,10);
      const list = flights.filter(f=>f.departure_date===today);
      if(list.length) renderResults(sorted(list), 'Showing flights for today');
      else renderResults(sorted(flights).slice(0,10), 'No flights today - showing top results');
    };

    document.getElementById('searchForm').addEventListener('submit',e=>{
      e.preventDefault();
      const q=Object.fromEntries(new FormData(e.currentTarget).entries());
      const exact = flights.filter(f =>
        (q.origin? f.origin===q.origin : true) &&
        (q.destination? f.destination===q.destination : true) &&
        (q.date? f.departure_date===q.date : true)
      );
      if(exact.length){
        renderResults(sorted(exact), 'Exact matches');
        return;
      }
      const note=document.getElementById('fallbackNote');
      if(q.origin && q.destination){
        const sameRouteAnyDate = flights.filter(f => f.origin===q.origin && f.destination===q.destination);
        if(sameRouteAnyDate.length){ renderResults(sorted(sameRouteAnyDate), 'No exact date match - showing same route on other dates'); note.style.display='block'; note.textContent='No exact date match, showing same route on other dates.'; return; }
      }
      if(q.origin){
        const sameOrigin = flights.filter(f => f.origin===q.origin);
        if(sameOrigin.length){ renderResults(sorted(sameOrigin), 'No route match - showing all from selected origin'); note.style.display='block'; note.textContent='No route match, showing all flights from the selected origin.'; return; }
      }
      renderResults(sorted(flights).slice(0,20), 'No match - showing most available flights');
      note.style.display='block'; note.textContent='No match, showing a broad set of flights.';
    });

    function sorted(list){
      return [...list].sort((a,b)=>{
        const ad=(a.departure_date||'')+(a.departure_time||'00:00');
        const bd=(b.departure_date||'')+(b.departure_time||'00:00');
        if(ad<bd) return -1; if(ad>bd) return 1; return 0;
      });
    }

    function renderResults(list, label){
      const wrap=document.getElementById('results'); wrap.innerHTML='';
      document.getElementById('count').textContent = (list.length)+' shown';
      if(label){ const n=document.getElementById('fallbackNote'); n.style.display='block'; n.textContent=label; }
      const t=document.createElement('table');
      t.innerHTML='<thead><tr><th>Flight</th><th>Route</th><th>Date</th><th>Time</th><th>Price</th><th></th></tr></thead>';
      const tb=document.createElement('tbody');
      for(const f of list){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><strong>${f.flight_number||f.id}</strong></td>
          <td>${f.origin} -> ${f.destination}</td>
          <td>${f.departure_date||f.date}</td>
          <td>${(f.departure_time||f.depart)||''} - ${(f.arrival_time||f.arrive)||''}</td>
          <td>${f.price!==undefined?('$'+f.price):''}</td>
          <td><button class="btn primary" data-pick="${(f.flight_number||f.id)||''}|${(f.departure_date||f.date)||''}">Select</button></td>`;
        tb.appendChild(tr);
      }
      t.appendChild(tb); wrap.appendChild(t);
      wrap.querySelectorAll('[data-pick]').forEach(b=>b.onclick=()=>{
        const [num,date]=b.dataset.pick.split('|');
        selectedFlight = flights.find(f=>(f.flight_number||f.id)===num && (f.departure_date||f.date)===date) ||
                         flights.find(f=>(f.flight_number||f.id)===num) || null;
        if(!selectedFlight) return;
        document.getElementById('step2').style.display='block';
        document.getElementById('chosenFlight').textContent=
          `${(selectedFlight.flight_number||selectedFlight.id)} • ${selectedFlight.origin} -> ${selectedFlight.destination} • ${(selectedFlight.departure_date||selectedFlight.date)} • ${(selectedFlight.departure_time||selectedFlight.depart)||''}`;
        renderSeatMap();
      });
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function seededRandom(seed){let h=0;for(let i=0;i<seed.length;i++){h=(h<<5)-h+seed.charCodeAt(i);h|=0}return function(){h^=h<<13;h^=h>>>17;h^=h<<5;return((h>>>0)%1000)/1000}}
    function takenMap(num,date){
      const rng=seededRandom(String(num)+String(date)), rows=18, cols=['A','B','C','D','E','F'], taken=new Set();
      for(let r=1;r<=rows;r++){for(const c of cols){if(rng()<0.2)taken.add(`${r}${c}`)}}
      for(const b of getBookings()){if((b.flight_number||b.flightId)===num && (b.departure_date||b.date)===date)taken.add(b.seat)}
      return {rows:18,cols:['A','B','C','D','E','F'],taken};
    }

    function renderSeatMap(){
      selectedSeat=null;
      const num=(selectedFlight.flight_number||selectedFlight.id);
      const date=(selectedFlight.departure_date||selectedFlight.date);
      const map=takenMap(num,date);
      const grid=document.createElement('div'); grid.className='grid';
      grid.appendChild(document.createElement('span'));
      for(const c of map.cols){const d=document.createElement('div');d.className='label';d.textContent=c;grid.appendChild(d)}
      for(let r=1;r<=map.rows;r++){
        const rl=document.createElement('div');rl.className='label';rl.textContent=r;grid.appendChild(rl);
        for(const c of map.cols){
          const code=`${r}${c}`, cell=document.createElement('div');cell.className='seat';cell.textContent=c;cell.title=code;
          if(map.taken.has(code))cell.classList.add('taken');
          cell.onclick=()=>{
            if(cell.classList.contains('taken'))return;
            grid.querySelectorAll('.seat.selected').forEach(s=>s.classList.remove('selected'));
            cell.classList.add('selected'); selectedSeat=code; document.getElementById('seatVal').textContent=selectedSeat;
          };
          grid.appendChild(cell);
        }
      }
      const hold=document.getElementById('seatWrap'); hold.innerHTML=''; hold.appendChild(grid);
    }

    document.getElementById('bookForm').addEventListener('submit',e=>{
      e.preventDefault();
      if(!selectedFlight||!selectedSeat){alert('Select a seat');return;}
      const data=Object.fromEntries(new FormData(e.currentTarget).entries());
      const pnr=('FD'+Math.random().toString(36).slice(2,7).toUpperCase());
      const booking={
        pnr,
        flight_number:(selectedFlight.flight_number||selectedFlight.id),
        origin:selectedFlight.origin,
        destination:selectedFlight.destination,
        departure_date:(selectedFlight.departure_date||selectedFlight.date),
        departure_time:(selectedFlight.departure_time||selectedFlight.depart)||'',
        arrival_time:(selectedFlight.arrival_time||selectedFlight.arrive)||'',
        price:selectedFlight.price,
        passenger:{firstName:data.firstName,lastName:data.lastName,email:data.email},
        seat:selectedSeat
      };
      const list=getBookings(); list.push(booking); saveBookings(list);
      document.getElementById('confirm').innerHTML=
        `<div class="note">Booked. PNR <span class="kbd">${pnr}</span>. Use Manage to view or change seat.</div>`;
      window.scrollTo({top:0,behavior:'smooth'});
      renderSeatMap();
      e.target.reset();
      document.getElementById('seatVal').textContent='-';
    });
  </script>
</body>
</html>
